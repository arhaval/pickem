-- ========================================
-- RLS HATASI TAM ÇÖZÜM - FINAL VERSİYON
-- ========================================
-- Bu SQL'i Supabase Dashboard > SQL Editor'da çalıştırın
-- "Run as" → "Service Role" seçin (RLS bypass için)
-- ========================================

-- ========================================
-- 1. PREDICTIONS TABLOSU RLS POLİTİKALARI
-- ========================================

DROP POLICY IF EXISTS "Kullanıcılar kendi tahminlerini ekleyebilir" ON predictions;
DROP POLICY IF EXISTS "Kullanıcılar kendi tahminlerini görebilir" ON predictions;
DROP POLICY IF EXISTS "Kullanıcılar kendi tahminlerini güncelleyebilir" ON predictions;
DROP POLICY IF EXISTS "Adminler tüm tahminleri görebilir" ON predictions;

ALTER TABLE predictions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Kullanıcılar kendi tahminlerini ekleyebilir"
ON predictions
FOR INSERT
TO authenticated
WITH CHECK (auth.uid()::text = user_id::text);

CREATE POLICY "Kullanıcılar kendi tahminlerini görebilir"
ON predictions
FOR SELECT
TO authenticated
USING (auth.uid()::text = user_id::text);

CREATE POLICY "Adminler tüm tahminleri görebilir"
ON predictions
FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM profiles
    WHERE profiles.id::text = auth.uid()::text
    AND profiles.is_admin = true
  )
);

-- ========================================
-- 2. PROFILES TABLOSU RLS POLİTİKALARI
-- ========================================

DROP POLICY IF EXISTS "Kullanıcılar kendi profilini görebilir" ON profiles;
DROP POLICY IF EXISTS "Kullanıcılar kendi profilini güncelleyebilir" ON profiles;
DROP POLICY IF EXISTS "Herkes profilleri görebilir" ON profiles;
DROP POLICY IF EXISTS "Kullanıcılar kendi profilini oluşturabilir" ON profiles;

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Herkes profilleri görebilir"
ON profiles
FOR SELECT
TO public
USING (true);

CREATE POLICY "Kullanıcılar kendi profilini güncelleyebilir"
ON profiles
FOR UPDATE
TO authenticated
USING (auth.uid()::text = id::text)
WITH CHECK (auth.uid()::text = id::text);

CREATE POLICY "Kullanıcılar kendi profilini oluşturabilir"
ON profiles
FOR INSERT
TO authenticated
WITH CHECK (auth.uid()::text = id::text);

-- ========================================
-- 3. SEASON_POINTS TABLOSU RLS POLİTİKALARI
-- ========================================

DROP POLICY IF EXISTS "Kullanıcılar kendi puanlarını görebilir" ON season_points;
DROP POLICY IF EXISTS "Herkes puanları görebilir" ON season_points;

DO $$
BEGIN
    IF EXISTS (SELECT FROM pg_tables WHERE tablename = 'season_points') THEN
        ALTER TABLE season_points ENABLE ROW LEVEL SECURITY;
        CREATE POLICY "Herkes puanları görebilir"
        ON season_points
        FOR SELECT
        TO public
        USING (true);
    END IF;
END $$;

-- ========================================
-- 4. STORAGE BUCKET RLS POLİTİKALARI
-- ========================================

DROP POLICY IF EXISTS "Kullanıcılar kendi avatarını yükleyebilir" ON storage.objects;
DROP POLICY IF EXISTS "Kullanıcılar kendi avatarını okuyabilir" ON storage.objects;
DROP POLICY IF EXISTS "Kullanıcılar kendi avatarını güncelleyebilir" ON storage.objects;
DROP POLICY IF EXISTS "Kullanıcılar kendi avatarını silebilir" ON storage.objects;
DROP POLICY IF EXISTS "Herkes avatarları okuyabilir" ON storage.objects;
DROP POLICY IF EXISTS "Adminler takım logolarını yükleyebilir" ON storage.objects;
DROP POLICY IF EXISTS "Herkes takım logolarını okuyabilir" ON storage.objects;
DROP POLICY IF EXISTS "Adminler takım logolarını silebilir" ON storage.objects;
DROP POLICY IF EXISTS "Adminler banner yükleyebilir" ON storage.objects;
DROP POLICY IF EXISTS "Herkes banner okuyabilir" ON storage.objects;

-- AVATARS BUCKET
-- Dosya adı formatı: avatar-{user_id}-{timestamp}.{ext}
CREATE POLICY "Kullanıcılar kendi avatarını yükleyebilir"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'avatars' AND
  (
    -- Klasör yapısı: {user_id}/avatar.*
    (storage.foldername(name))[1] = auth.uid()::text
    OR
    -- Dosya adı: avatar-{user_id}-*
    (name LIKE 'avatar-' || auth.uid()::text || '-%')
  )
);

CREATE POLICY "Herkes avatarları okuyabilir"
ON storage.objects
FOR SELECT
TO public
USING (bucket_id = 'avatars');

CREATE POLICY "Kullanıcılar kendi avatarını güncelleyebilir"
ON storage.objects
FOR UPDATE
TO authenticated
USING (
  bucket_id = 'avatars' AND
  (
    (storage.foldername(name))[1] = auth.uid()::text
    OR
    (name LIKE 'avatar-' || auth.uid()::text || '-%')
  )
)
WITH CHECK (
  bucket_id = 'avatars' AND
  (
    (storage.foldername(name))[1] = auth.uid()::text
    OR
    (name LIKE 'avatar-' || auth.uid()::text || '-%')
  )
);

CREATE POLICY "Kullanıcılar kendi avatarını silebilir"
ON storage.objects
FOR DELETE
TO authenticated
USING (
  bucket_id = 'avatars' AND
  (
    (storage.foldername(name))[1] = auth.uid()::text
    OR
    (name LIKE 'avatar-' || auth.uid()::text || '-%')
  )
);

-- TEAMS BUCKET
CREATE POLICY "Adminler takım logolarını yükleyebilir"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'teams' AND
  EXISTS (
    SELECT 1 FROM profiles
    WHERE profiles.id::text = auth.uid()::text
    AND profiles.is_admin = true
  )
);

CREATE POLICY "Herkes takım logolarını okuyabilir"
ON storage.objects
FOR SELECT
TO public
USING (bucket_id = 'teams');

CREATE POLICY "Adminler takım logolarını silebilir"
ON storage.objects
FOR DELETE
TO authenticated
USING (
  bucket_id = 'teams' AND
  EXISTS (
    SELECT 1 FROM profiles
    WHERE profiles.id::text = auth.uid()::text
    AND profiles.is_admin = true
  )
);

-- BANNERS BUCKET
CREATE POLICY "Adminler banner yükleyebilir"
ON storage.objects
FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'banners' AND
  EXISTS (
    SELECT 1 FROM profiles
    WHERE profiles.id::text = auth.uid()::text
    AND profiles.is_admin = true
  )
);

CREATE POLICY "Herkes banner okuyabilir"
ON storage.objects
FOR SELECT
TO public
USING (bucket_id = 'banners');

-- ========================================
-- 5. SITE_SETTINGS TABLOSU
-- ========================================

DO $$
BEGIN
    IF EXISTS (SELECT FROM pg_tables WHERE tablename = 'site_settings') THEN
        DROP POLICY IF EXISTS "Herkes site ayarlarını görebilir" ON site_settings;
        DROP POLICY IF EXISTS "Adminler site ayarlarını güncelleyebilir" ON site_settings;
        
        ALTER TABLE site_settings ENABLE ROW LEVEL SECURITY;
        
        CREATE POLICY "Herkes site ayarlarını görebilir"
        ON site_settings
        FOR SELECT
        TO public
        USING (true);
        
        CREATE POLICY "Adminler site ayarlarını güncelleyebilir"
        ON site_settings
        FOR UPDATE
        TO authenticated
        USING (
          EXISTS (
            SELECT 1 FROM profiles
            WHERE profiles.id::text = auth.uid()::text
            AND profiles.is_admin = true
          )
        );
    END IF;
END $$;

-- ========================================
-- ✅ TAMAMLANDI!
-- ========================================

